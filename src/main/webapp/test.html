<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>CruiseMonkey Tests</title>
	<link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.10.0.css">
</head>
<body>
	<div id="qunit"></div>
	<div id="qunit-fixture"></div>
	<script src="jquery/jquery-1.8.1.js"></script>
	<script src="http://code.jquery.com/qunit/qunit-1.10.0.js"></script>
  <script src="amplifyjs/amplify.min.js"></script>
	<script src="scroll_manager.js"></script>
	<script src="page_tracker.js"></script>
	<script>
		module("ScrollManager tests", {
			setup: function() {
				var fixture = $('#qunit-fixture');
				$(fixture).append('<ol>');
				for (var i = 1; i <= 1000; i++) {
					$(fixture).append('<li id="' + i + '">ID #' + i + '</li>');
				}
				$(fixture).append('</ol>');
			},
			teardown: function() {
				var fixture = $('#qunit-fixture');
				$(fixture).empty();
			}
		});

		/* callbacks are called while enabled */
		asyncTest('scrollManager.enabled', 2, function() {
			var scrollManager = new ScrollManager();
			var started = 0;
			var stopped = 0;
			scrollManager.onScrollStart = function(enabled) {
				if (enabled) { started++; }
			};
			scrollManager.onScrollStop = function(enabled) {
				if (enabled) { stopped++; }
			};
			scrollManager.delay = 10;

			$('#500').scroll();
			setTimeout(function() {
				equal(started, 1, 'ScrollManager should have started scrolling once.');
				equal(stopped, 1, 'ScrollManager should have completed scrolling once.');
				start();
			}, 50);
		});

		/* callbacks should not be called while disabled */
		asyncTest('scrollManager.disabled', 4, function() {
			var scrollManager = new ScrollManager();
			var started = 0;
			var stopped = 0;
			var started_while_disabled = 0;
			var stopped_while_disabled = 0;
			scrollManager.onScrollStart = function(enabled) {
				if (enabled) {
					started++;
				} else {
					started_while_disabled++;
				}
			};
			scrollManager.onScrollStop = function(enabled) {
				if (enabled) {
					stopped++;
				} else {
					stopped_while_disabled++;
				}
			};
			scrollManager.delay = 10;
			scrollManager.disable();

			$('#500').scroll();
			setTimeout(function() {
				equal(started, 0, 'ScrollManager should not have started scrolling.');
				equal(stopped, 0, 'ScrollManager should not have completed scrolling.');
				equal(started_while_disabled, 1, 'ScrollManager should have started disabled scrolling.');
				equal(stopped_while_disabled, 1, 'ScrollManager should have completed disabled scrolling.');
				start();
			}, 50);
		});

		module("PageTracker tests", {
			setup: function() {
			},
			teardown: function() {
				var fixture = $('#qunit-fixture');
				$(fixture).empty();
			}
		});

		test('pageTracker.basic', 3, function() {
			raises(function() {
				var pageTracker = new PageTracker(null);
			}, TypeError, "Expecting a type error when passing an invalid amplify object.");

			var pageTracker = new PageTracker(amplify);
			pageTracker.setScrolledId('bar', 'baz');
			equal('baz', pageTracker.getScrolledId('bar'));

			equal(null, pageTracker.getScrolledId('foo'));
		});
	</script>
</body>
</html>